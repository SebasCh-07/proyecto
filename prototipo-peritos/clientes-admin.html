<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Clientes</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav class="topbar">
    <div class="brand">Peritos • Admin</div>
    <div class="navlinks">
      <a href="peritos-admin.html" style="padding-left:20px">Historial Peritos</a>
      <a href="clientes-admin.html">Clientes</a>
      <button id="logoutBtn" class="link danger">Salir</button>
    </div>
  </nav>
  <div class="card">
    <h2>Lista de Clientes</h2>
    <p class="muted">Haz clic en cualquier cliente para seleccionar un perito</p>
    <table id="tablaClientes">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Contacto</th>
          <th>Teléfono</th>
          <th>Requerimientos Activos</th>
        </tr>
      </thead>
      <tbody>
        <!-- Se llenará con JS -->
      </tbody>
    </table>
  </div>

  <script>
    // --- DB simulada en localStorage ---
    const DBKEY = 'peritosDB_v1';
    const now = () => new Date().toISOString();
    const loadDB = () => {
      const raw = localStorage.getItem(DBKEY);
      if (raw) return JSON.parse(raw);
      const db = {
        user: { role: 'admin', name: 'admin' },
        reqs: [
          {id:'r1', cliente:'Reisac', contacto:'Juan Piguave', tel:'0999999999', perito:'perito1',
            estado:'pendiente', created: now()},
          {id:'r2', cliente:'BancoX', contacto:'María Rojas', tel:'022345678', perito:'perito1',
            estado:'curso', created: now()},
          {id:'r3', cliente:'Constructora Y', contacto:'Carlos Vega', tel:'023334455', perito:'perito2',
            estado:'finalizado', created: now()}
        ]
      };
      localStorage.setItem(DBKEY, JSON.stringify(db));
      return db;
    };
    const saveDB = (db) => localStorage.setItem(DBKEY, JSON.stringify(db));
    let DB = loadDB();

    // --- Logout ---
    function logout(){
      DB.user = null;
      saveDB(DB);
      window.location.href = 'index.html';
    }

    // --- Renderizar clientes ---
    function renderClientes() {
      const tbody = document.querySelector('#tablaClientes tbody');
      tbody.innerHTML = '';

      // Agrupar requerimientos por cliente
      const clientesMap = {};
      DB.reqs.forEach(req => {
        if (!clientesMap[req.cliente]) {
          clientesMap[req.cliente] = {
            nombre: req.cliente,
            contacto: req.contacto,
            telefono: req.tel,
            activos: 0
          };
        }
        if (req.estado === 'pendiente' || req.estado === 'curso') {
          clientesMap[req.cliente].activos++;
        }
      });

      // Pintar en la tabla
      Object.values(clientesMap).forEach(cli => {
        const tr = document.createElement('tr');
        tr.classList.add('clickable-row');
        tr.innerHTML = `
          <td>${cli.nombre}</td>
          <td>${cli.contacto}</td>
          <td>${cli.telefono}</td>
          <td>${cli.activos}</td>
        `;
        tbody.appendChild(tr);

        // Evento click en la fila
        tr.onclick = () => {
          localStorage.setItem('cliSel', cli.nombre);
          location.href = 'peritos-admin.html';
        };
      });
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) logoutBtn.addEventListener('click', logout);
      renderClientes();
    });
  </script>
</body>
</html>
